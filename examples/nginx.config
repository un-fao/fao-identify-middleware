# File: nginx.conf (conceptual example)

server {
    listen 443 ssl;
    server_name my-proxy.com;

    # SSL Config...
    # ssl_certificate /path/to/cert.pem;
    # ssl_certificate_key /path/to/key.pem;

    # The actual URL of your IAP-protected app
    set $iap_upstream [https://real-app.iap.google.com](https://real-app.iap.google.com);

    # Location for IAP renewal
    location /renew-iap {
        # Pass the entire request to the real IAP app
        proxy_pass $iap_upstream;

        # Forward all original headers to IAP
        proxy_pass_request_headers on;
        
        # Set host header correctly
        proxy_set_header Host $host;
        
        # Make sure cookies are passed
        proxy_set_header Cookie $http_cookie;
        
        # --- This is the most critical part ---
        # After IAP logs in and sets its cookie, it will
        # redirect. We intercept that redirect and send
        # the user back to the URL from the 'redirect'
        # query parameter.
        
        # $arg_redirect captures the 'redirect' query param
        if ($arg_redirect) {
            # This rewrites the 'Location' header
            # from IAP's response to point back to our frontend
            proxy_redirect $iap_upstream / $arg_redirect;
            
            # This is a fallback if IAP redirects to /
            proxy_redirect / $arg_redirect;
        }
    }

    # Other locations for your frontend/backend...
}